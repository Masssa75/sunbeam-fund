#!/usr/bin/env node

const fetch = require('node-fetch');

async function testTelegramAPI() {
  console.log('üß™ Testing Telegram API fix...\n');

  // First, let's check the GET endpoint
  console.log('1. Testing GET /api/telegram/test...');
  try {
    const getResponse = await fetch('http://localhost:3001/api/telegram/test', {
      headers: {
        'Cookie': 'sb-gualxudgbmpuhjbumfeh-auth-token=base64-eyJhY2Nlc3NfdG9rZW4iOiJleUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKaGRXUWlPaUpoZFhSb1pXNTBhV05oZEdWa0lpd2laWGh3SWpveE56VTJOamcwT1RNeExDSnBZWFFpT2pFM05UWTJPREV6TXpFc0ltbHpjeUk2SW1oMGRIQnpPaTh2WjNWaGJIaDFaR2RpYlhCMWFHcGlkVzFtWldndWMzVndZV0poYzJVdVkyOGlMQ0p6ZFdJaU9pSTNOR014WTJFM055MDBZamsxTFRSaE56WXRZV0prTkMwMlpqYzNZamt6WVdJNU1qQWlMQ0psYldGcGJDSTZJbTFoY21OQWJXbHVkWFJsZG1sa1pXOXpMbU52YlNJc0luQm9iMjVsSWpvaUlpd2lZWEJ3WDIxbGRHRmtZWFJoSWpwN0luQnliM1pwWkdWeUlqb2laVzFoYVd3aUxDSndjbTkyYVdSbGNuTWlPbHNpWlcxaGFXd2lYWDBzSW5WelpYSmZiV1YwWVdSaGRHRWlPbnNpWVhaaGRHRnlYM1Z5YkNJNklpSXNJbVZ0WVdsc0lqb2liV0Z5WTBCdGFXNTFkR1YyYVdSbGIzTXVZMjl0SWl3aVpXMWhhV3hmZG1WeWFXWnBaV1FpT2lKMGNuVmxJaXdpWm5Wc2JGOXVZVzFsSWpvaUlpd2lhWE56SWpvaWFIUjBjSE02THk5emRYQmhZbUZ6WlM1amJ5SXNJbTVoYldVaU9pSWlMQ0J3YVdOMGRYSmxJam9pSWl3aWNISnZkbWxrWlhKZmFXUWlPaUl3TTJRek9EbGlZUzAwWkRrd0xUUTBaR1l0WWpVek1TMW1OMkZpTjJaa1l6WmxOV1FpTENKemRXSWlPaUkzTkdNeFkyRTNOeTAwWWprMExUUmhOell0WVdKa05DMDJaamMzWWprelkXSjVNakFpZlN3aWNtOXNaU0k2SW1GMWRHaGxiblJwWTJGMFpXUWlMQ0poWVd3aU9pSmhZV3d4SWl3aVlXMXlJanBiWXlKbGJXRnBiQ0pkTENKelpYTnphVzl1WDJsa0lqb2lZMkV5TlRJNVpqZ3RZak14TWkwME1UVmhMV0kyTnpRdFptSXlaRGN3TkdFNFpqZzJJaXdpYVhOZllXNXZibmx0YjNWeklqcG1ZV3h6WlgwLlE5V0NncmJZc29MVGhUb0FnNEJuSWkxR21ldVhQa2tnMzM3SkdJZHptSlUiLCJyZWZyZXNoX3Rva2VuIjoiMDFZdE10R0xQMHZjXzZaYlZUMzZnUSIsInRva2VuX3R5cGUiOiJiZWFyZXIiLCJ1c2VyIjp7ImlkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiYXVkIjoiYXV0aGVudGljYXRlZCIsInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF9jb25maXJtZWRfYXQiOiIyMDI1LTA2LTIzVDEwOjQ4OjMzLjA5NzI1OVoiLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl19LCJ1c2VyX21ldGFkYXRhIjp7ImF2YXRhcl91cmwiOiIiLCJlbWFpbCI6Im1hcmNAbWludXRldmlkZW9zLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjoidHJ1ZSIsImZ1bGxfbmFtZSI6IiIsImlzcyI6Imh0dHBzOi8vc3VwYWJhc2UuY28iLCJuYW1lIjoiIiwicGljdHVyZSI6IiIsInByb3ZpZGVyX2lkIjoiMDNkMzg5YmEtNGQ5MC00NGRmLWI1MzEtZjdhYjdmZGM2ZTVkIiwic3ViIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIn0sImlkZW50aXRpZXMiOlt7ImlkZW50aXR5X2lkIjoiMDNkMzg5YmEtNGQ5MC00NGRmLWI1MzEtZjdhYjdmZGM2ZTVkIiwiaWQiOiI3NGMxY2E3Ny00Yjk0LTRhNzYtYWJkNC02Zjc3YjkzYWI5MjAiLCJ1c2VyX2lkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiaWRlbnRpdHlfZGF0YSI6eyJhdmF0YXJfdXJsIjoiIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF92ZXJpZmllZCI6InRydWUiLCJmdWxsX25hbWUiOiIiLCJpc3MiOiJodHRwczovL3N1cGFiYXNlLmNvIiwibmFtZSI6IiIsInBpY3R1cmUiOiIiLCJwcm92aWRlcl9pZCI6IjAzZDM4OWJhLTRkOTAtNDRkZi1iNTMxLWY3YWI3ZmRjNmU1ZCIsInN1YiI6Ijc0YzFjYTc3LTRiOTQtNGE3Ni1hYmRkNTc2LTZmNzdiOTNhYjkyMCJ9LCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wOTE3MjZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjU2MjJaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY1NjIyWiIsImVtYWlsIjoibWFyY0BtaW51dGV2aWRlb3MuY29tIn1dLCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wODc3NTZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjMzNDRaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY5MjI1WiIsImlzX2Fub255bW91cyI6ZmFsc2V9fQ==',
      }
    });

    if (!getResponse.ok) {
      console.log(`‚ùå GET request failed with status: ${getResponse.status}`);
      const error = await getResponse.text();
      console.log('Error:', error);
    } else {
      const data = await getResponse.json();
      console.log('‚úÖ GET response:', JSON.stringify(data, null, 2));
    }
  } catch (error) {
    console.log('‚ùå GET request failed:', error.message);
  }

  console.log('\n2. Testing POST /api/telegram/test (without chat ID)...');
  try {
    const postResponse = await fetch('http://localhost:3001/api/telegram/test', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cookie': 'sb-gualxudgbmpuhjbumfeh-auth-token=base64-eyJhY2Nlc3NfdG9rZW4iOiJleUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKaGRXUWlPaUpoZFhSb1pXNTBhV05oZEdWa0lpd2laWGh3SWpveE56VTJOamcwT1RNeExDSnBZWFFpT2pFM05UWTJPREV6TXpFc0ltbHpjeUk2SW1oMGRIQnpPaTh2WjNWaGJIaDFaR2RpYlhCMWFHcGlkVzFtWldndWMzVndZV0poYzJVdVkyOGlMQ0p6ZFdJaU9pSTNOR014WTJFM055MDBZamsxTFRSaE56WXRZV0prTkMwMlpqYzNZamt6WVdJNU1qQWlMQ0psYldGcGJDSTZJbTFoY21OQWJXbHVkWFJsZG1sa1pXOXpMbU52YlNJc0luQm9iMjVsSWpvaUlpd2lZWEJ3WDIxbGRHRmtZWFJoSWpwN0luQnliM1pwWkdWeUlqb2laVzFoYVd3aUxDSndjbTkyYVdSbGNuTWlPbHNpWlcxaGFXd2lYWDBzSW5WelpYSmZiV1YwWVdSaGRHRWlPbnNpWVhaaGRHRnlYM1Z5YkNJNklpSXNJbVZ0WVdsc0lqb2liV0Z5WTBCdGFXNTFkR1YyYVdSbGIzTXVZMjl0SWl3aVpXMWhhV3hmZG1WeWFXWnBaV1FpT2lKMGNuVmxJaXdpWm5Wc2JGOXVZVzFsSWpvaUlpd2lhWE56SWpvaWFIUjBjSE02THk5emRYQmhZbUZ6WlM1amJ5SXNJbTVoYldVaU9pSWlMQ0J3YVdOMGRYSmxJam9pSWl3aWNISnZkbWxrWlhKZmFXUWlPaUl3TTJRek9EbGlZUzAwWkRrd0xUUTBaR1l0WWpVek1TMW1OMkZpTjJaa1l6WmxOV1FpTENKemRXSWlPaUkzTkdNeFkyRTNOeTAwWWprMExUUmhOell0WVdKa05DMDJaamMzWWprelkXSjVNakFpZlN3aWNtOXNaU0k2SW1GMWRHaGxiblJwWTJGMFpXUWlMQ0poWVd3aU9pSmhZV3d4SWl3aVlXMXlJanBiWXlKbGJXRnBiQ0pkTENKelpYTnphVzl1WDJsa0lqb2lZMkV5TlRJNVpqZ3RZak14TWkwME1UVmhMV0kyTnpRdFptSXlaRGN3TkdFNFpqZzJJaXdpYVhOZllXNXZibmx0YjNWeklqcG1ZV3h6WlgwLlE5V0NncmJZc29MVGhUb0FnNEJuSWkxR21ldVhQa2tnMzM3SkdJZHptSlUiLCJyZWZyZXNoX3Rva2VuIjoiMDFZdE10R0xQMHZjXzZaYlZUMzZnUSIsInRva2VuX3R5cGUiOiJiZWFyZXIiLCJ1c2VyIjp7ImlkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiYXVkIjoiYXV0aGVudGljYXRlZCIsInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF9jb25maXJtZWRfYXQiOiIyMDI1LTA2LTIzVDEwOjQ4OjMzLjA5NzI1OVoiLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl19LCJ1c2VyX21ldGFkYXRhIjp7ImF2YXRhcl91cmwiOiIiLCJlbWFpbCI6Im1hcmNAbWludXRldmlkZW9zLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjoidHJ1ZSIsImZ1bGxfbmFtZSI6IiIsImlzcyI6Imh0dHBzOi8vc3VwYWJhc2UuY28iLCJuYW1lIjoiIiIsInBpY3R1cmUiOiIiLCJwcm92aWRlcl9pZGJ6ZGM2ZTVkIiwic3ViIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIn0sImlkZW50aXRpZXMiOlt7ImlkZW50aXR5X2lkIjoiMDNkMzg5YmEtNGQ5MC00NGRmLWI1MzEtZjdhYjdmZGM2ZTVkIiwiaWQiOiI3NGMxY2E3Ny00Yjk0LTRhNzYtYWJkNC02Zjc3YjkzYWI5MjAiLCJ1c2VyX2lkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiaWRlbnRpdHlfZGF0YSI6eyJhdmF0YXJfdXJsIjoiIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF92ZXJpZmllZCI6InRydWUiLCJmdWxsX25hbWUiOiIiLCJpc3MiOiJodHRwczovL3N1cGFiYXNlLmNvIiwibmFtZSI6IiIsInBpY3R1cmUiOiIiLCJwcm92aWRlcl9pZCI6IjAzZDM4OWJhLTRkOTAtNDRkZi1iNTMxLWY3YWI3ZmRjNmU1ZCIsInN1YiI6Ijc0YzFjYTc3LTRiOTQtNGE3Ni1hYmRkNTc2LTZmNzdiOTNhYjkyMCJ9LCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wOTE3MjZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjU2MjJaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY1NjIyWiIsImVtYWlsIjoibWFyY0BtaW51dGV2aWRlb3MuY29tIn1dLCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wODc3NTZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjMzNDRaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY5MjI1WiIsImlzX2Fub255bW91cyI6ZmFsc2V9fQ==',
      },
      body: JSON.stringify({
        message: 'Test message from API fix - no chat ID provided',
      }),
    });

    const data = await postResponse.json();
    if (postResponse.ok) {
      console.log('‚úÖ POST response:', JSON.stringify(data, null, 2));
    } else {
      console.log(`‚ùå POST request failed with status: ${postResponse.status}`);
      console.log('Error:', JSON.stringify(data, null, 2));
    }
  } catch (error) {
    console.log('‚ùå POST request failed:', error.message);
  }

  console.log('\n3. Testing POST with Marc\'s chat ID...');
  try {
    const postResponse = await fetch('http://localhost:3001/api/telegram/test', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cookie': 'sb-gualxudgbmpuhjbumfeh-auth-token=base64-eyJhY2Nlc3NfdG9rZW4iOiJleUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKaGRXUWlPaUpoZFhSb1pXNTBhV05oZEdWa0lpd2laWGh3SWpveE56VTJOamcwT1RNeExDSnBZWFFpT2pFM05UWTJPREV6TXpFc0ltbHpjeUk2SW1oMGRIQnpPaTh2WjNWaGJIaDFaR2RpYlhCMWFHcGlkVzFtWldndWMzVndZV0poYzJVdVkyOGlMQ0p6ZFdJaU9pSTNOR014WTJFM055MDBZamsxTFRSaE56WXRZV0prTkMwMlpqYzNZamt6WVdJNU1qQWlMQ0psYldGcGJDSTZJbTFoY21OQWJXbHVkWFJsZG1sa1pXOXpMbU52YlNJc0luQm9iMjVsSWpvaUlpd2lZWEJ3WDIxbGRHRmtZWFJoSWpwN0luQnliM1pwWkdWeUlqb2laVzFoYVd3aUxDSndjbTkyYVdSbGNuTWlPbHNpWlcxaGFXd2lYWDBzSW5WelpYSmZiV1YwWVdSaGRHRWlPbnNpWVhaaGRHRnlYM1Z5YkNJNklpSXNJbVZ0WVdsc0lqb2liV0Z5WTBCdGFXNTFkR1YyYVdSbGIzTXVZMjl0SWl3aVpXMWhhV3hmZG1WeWFXWnBaV1FpT2lKMGNuVmxJaXdpWm5Wc2JGOXVZVzFsSWpvaUlpd2lhWE56SWpvaWFIUjBjSE02THk5emRYQmhZbUZ6WlM1amJ5SXNJbTVoYldVaU9pSWlMQ0J3YVdOMGRYSmxJam9pSWl3aWNISnZkbWxrWlhKZmFXUWlPaUl3TTJRek9EbGlZUzAwWkRrd0xUUTBaR1l0WWpVek1TMW1OMkZpTjJaa1l6WmxOV1FpTENKemRXSWlPaUkzTkdNeFkyRTNOeTAwWWprMExUUmhOell0WVdKa05DMDJaamMzWWprelkXSjVNakFpZlN3aWNtOXNaU0k2SW1GMWRHaGxiblJwWTJGMFpXUWlMQ0poWVd3aU9pSmhZV3d4SWl3aVlXMXlJanBiWXlKbGJXRnBiQ0pkTENKelpYTnphVzl1WDJsa0lqb2lZMkV5TlRJNVpqZ3RZak14TWkwME1UVmhMV0kyTnpRdFptSXlaRGN3TkdFNFpqZzJJaXdpYVhOZllXNXZibmx0YjNWeklqcG1ZV3h6WlgwLlE5V0NncmJZc29MVGhUb0FnNEJuSWkxR21ldVhQa2tnMzM3SkdJZHptSlUiLCJyZWZyZXNoX3Rva2VuIjoiMDFZdE10R0xQMHZjXzZaYlZUMzZnUSIsInRva2VuX3R5cGUiOiJiZWFyZXIiLCJ1c2VyIjp7ImlkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiYXVkIjoiYXV0aGVudGljYXRlZCIsInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF9jb25maXJtZWRfYXQiOiIyMDI1LTA2LTIzVDEwOjQ4OjMzLjA5NzI1OVoiLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl19LCJ1c2VyX21ldGFkYXRhIjp7ImF2YXRhcl91cmwiOiIiLCJlbWFpbCI6Im1hcmNAbWludXRldmlkZW9zLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjoidHJ1ZSIsImZ1bGxfbmFtZSI6IiIsImlzcyI6Imh0dHBzOi8vc3VwYWJhc2UuY28iLCJuYW1lIjoiIiIsInBpY3R1cmUiOiIiLCJwcm92aWRlcl9pZGJ6ZGM2ZTVkIiwic3ViIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIn0sImlkZW50aXRpZXMiOlt7ImlkZW50aXR5X2lkIjoiMDNkMzg5YmEtNGQ5MC00NGRmLWI1MzEtZjdhYjdmZGM2ZTVkIiwiaWQiOiI3NGMxY2E3Ny00Yjk0LTRhNzYtYWJkNC02Zjc3YjkzYWI5MjAiLCJ1c2VyX2lkIjoiNzRjMWNhNzctNGI5NC00YTc2LWFiZDQtNmY3N2I5M2FiOTIwIiwiaWRlbnRpdHlfZGF0YSI6eyJhdmF0YXJfdXJsIjoiIiwiZW1haWwiOiJtYXJjQG1pbnV0ZXZpZGVvcy5jb20iLCJlbWFpbF92ZXJpZmllZCI6InRydWUiLCJmdWxsX25hbWUiOiIiLCJpc3MiOiJodHRwczovL3N1cGFiYXNlLmNvIiwibmFtZSI6IiIsInBpY3R1cmUiOiIiLCJwcm92aWRlcl9pZCI6IjAzZDM4OWJhLTRkOTAtNDRkZi1iNTMxLWY3YWI3ZmRjNmU1ZCIsInN1YiI6Ijc0YzFjYTc3LTRiOTQtNGE3Ni1hYmRkNTc2LTZmNzdiOTNhYjkyMCJ9LCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wOTE3MjZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjU2MjJaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY1NjIyWiIsImVtYWlsIjoibWFyY0BtaW51dGV2aWRlb3MuY29tIn1dLCJjcmVhdGVkX2F0IjoiMjAyNS0wNi0yM1QxMDo0ODozMy4wODc3NTZaIiwibGFzdF9zaWduX2luX2F0IjoiMjAyNS0wNi0yNVQxNzoyODo1MS42NjMzNDRaIiwidXBkYXRlZF9hdCI6IjIwMjUtMDYtMjVUMTc6Mjg6NTEuNjY5MjI1WiIsImlzX2Fub255bW91cyI6ZmFsc2V9fQ==',
      },
      body: JSON.stringify({
        chatId: '5089502326', // Marc's Telegram chat ID
        message: '<b>Test Message from API Fix</b>\n\nThis is a test notification from Sunbeam Fund admin panel.',
      }),
    });

    const data = await postResponse.json();
    if (postResponse.ok) {
      console.log('‚úÖ POST response:', JSON.stringify(data, null, 2));
    } else {
      console.log(`‚ùå POST request failed with status: ${postResponse.status}`);
      console.log('Error:', JSON.stringify(data, null, 2));
    }
  } catch (error) {
    console.log('‚ùå POST request failed:', error.message);
  }

  console.log('\nDone! Check the Telegram API endpoints.');
}

testTelegramAPI();